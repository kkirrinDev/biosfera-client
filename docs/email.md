# Логика работы и отправки почты

## Общая схема

1. **Форма** (`Form.tsx`) — пользователь вводит имя и телефон, соглашается с политикой, нажимает «Оставить заявку».
2. **API-роут** (`/api/emails`) — принимает POST с телом запроса и вызывает утилиту отправки письма.
3. **Утилита** (`mail.js`) — формирует и отправляет письмо через nodemailer по SMTP.

---

## 1. Форма (Form.tsx)

- Поля: **имя**, **телефон**, чекбокс согласия с политикой.
- Валидация через react-hook-form (обязательные поля + согласие).
- На телефоне — маска из `phone-mask.js`.
- При отправке:
  - `sending = true` (показ индикатора).
  - POST на `/api/emails` с телом: `{ name, phone, policy }` в JSON.
- При успехе (response.ok): показ «Ваша заявка успешно отправлена», сброс формы, сброс ошибки.
- При ошибке: сообщение «Что-то пошло не так» или «Ошибка запроса, попробуйте позже», `sending = false`.

---

## 2. API-роут (src/app/api/emails/route.js)

- Обрабатывает только **POST**.
- Читает тело запроса: `await request.json()`.
- Вызывает `sendEmail(body)` из `utils/mail.js`.
- При успехе возвращает JSON: `{ accepted, message: "Письмо успешно отправлено" }` и статус 200.
- При ошибке — статус 500 и JSON: `{ message: "что-то сломалось в роуте апи emails", error: error.message }`.

---

## 3. Отправка письма (src/app/utils/mail.js)

- **Транспорт**: nodemailer с SMTP.
  - Параметры из переменных окружения: `SMTP_HOST`, `SMTP_USERNAME`, `SMTP_PASSWORD`, `SMTP_FROM`.
  - Порт 465, `secure: true`.
- **Письмо**:
  - **from**: `process.env.SMTP_FROM`
  - **to**: `SMTP_FROM` и `Dubrovinaaa@yandex.ru`
  - **subject**: «Форма с сайта dubrovinastom.ru»
  - **text**: `Имя: ${body.name}\nТелефон: ${body.phone}`
  - **html**: те же данные в виде HTML (`<b>Имя:</b>`, `<b>Телефон:</b>`).
- В теле письма используются только `body.name` и `body.phone`; поле `policy` в письмо не попадает.
- При ошибке отправки исключение пробрасывается выше (обрабатывается в API-роуте).

---

## Переменные окружения

Для работы отправки должны быть заданы:

- `SMTP_HOST` — хост SMTP-сервера
- `SMTP_USERNAME` — логин
- `SMTP_PASSWORD` — пароль
- `SMTP_FROM` — адрес отправителя (и один из получателей)
